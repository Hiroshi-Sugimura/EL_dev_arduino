<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>EL_dev_arduino: Overview (EL_dev_arduino)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">EL_dev_arduino<span id="projectnumber">&#160;3.0.0</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 構築: Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','検索');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">読み取り中…</div>
<div class="SRStatus" id="Searching">検索中…</div>
<div class="SRStatus" id="NoMatches">一致する文字列を見つけられません</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Overview (EL_dev_arduino) </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>このモジュールはArduinoの**ECHONET Liteプロトコル**通信をサポートします． (ECHONET Liteプロトコルはスマートハウス機器の通信プロトコルです．) M5Stack Core2を中心にテストしています。 <b>本モジュールはECHONET Lite認証を受けたものではありませんので、商品化する際には開発者自らが認証を受ける必要があります。</b></p>
<p>This module provides the communication method, <b>ECHONET Lite protocol</b>, for Arduino. (ECHONET Lite protocol is a common communication specification for Smart home) We are developping and debugging with M5stack Core2 mainly.</p>
<h1><a class="anchor" id="autotoc_md1"></a>
Install</h1>
<p>Arduino IDEのライブラリマネージャからモジュールをインストールできます． sugimuraでフィルタするとすぐ出ます。</p>
<ol type="1">
<li>Arduino IDEを起動する</li>
<li>メニュー &gt; スケッチ &gt; ライブラリをインクルード &gt; ライブラリを管理</li>
<li>sugimuraでフィルタ</li>
<li>EL_dev_arduinoをインストール</li>
</ol>
<p>You can install the module by using Library Manager of ArduinoIDE as following. It can be found to use filter text 'sugimura', author's name.</p>
<ol type="1">
<li>Start ArduinoIDE</li>
<li>Menu &gt; Sketch &gt; Include Library &gt; Library Manager</li>
<li>Filter [sugimura]</li>
<li>Install EL_dev_arduino</li>
</ol>
<h1><a class="anchor" id="autotoc_md2"></a>
API Manual</h1>
<p><a href="https://hiroshi-sugimura.github.io/EL_dev_arduino/documents/html/index.html">https://hiroshi-sugimura.github.io/EL_dev_arduino/documents/html/index.html</a></p>
<h1><a class="anchor" id="autotoc_md3"></a>
Example (General Lighting)</h1>
<div class="fragment"><div class="line">#include &lt;M5Stack.h&gt;</div>
<div class="line">#include &lt;WiFi.h&gt;</div>
<div class="line">#include &quot;EL.h&quot;</div>
<div class="line"> </div>
<div class="line">#define WIFI_SSID &quot;change your wifi ssid&quot;</div>
<div class="line">#define WIFI_PASS &quot;change your wifi password&quot;</div>
<div class="line"> </div>
<div class="line">WiFiClient client;</div>
<div class="line">WiFiUDP elUDP;</div>
<div class="line">EL echo(elUDP, 0x02, 0x90, 0x01 );</div>
<div class="line"> </div>
<div class="line">void printNetData();</div>
<div class="line"> </div>
<div class="line">void setup() {</div>
<div class="line">  // put your setup code here, to run once:</div>
<div class="line">  Serial.begin(115200);</div>
<div class="line">  Serial.println(&quot;&quot;);</div>
<div class="line">  M5.begin();</div>
<div class="line">  M5.Lcd.setTextSize(2);</div>
<div class="line">  M5.Lcd.println(&quot;wifi connect start&quot;);</div>
<div class="line"> </div>
<div class="line">  WiFi.begin(WIFI_SSID, WIFI_PASS);</div>
<div class="line">  while (WiFi.status() != WL_CONNECTED) {</div>
<div class="line">    Serial.println(&quot;wait...&quot;);</div>
<div class="line">    delay(1000);</div>
<div class="line">  }</div>
<div class="line">  M5.Lcd.println(&quot;wifi connect ok&quot;);</div>
<div class="line">  M5.update();</div>
<div class="line"> </div>
<div class="line">  printNetData();</div>
<div class="line">  echo.begin();            // EL 起動シーケンス</div>
<div class="line"> </div>
<div class="line">  // 一般照明の状態，繋がった宣言として立ち上がったことをコントローラに知らせるINFを飛ばす</div>
<div class="line">  const byte deoj[] = {0x05, 0xff, 0x01};</div>
<div class="line">  const byte edt[] = {0x01, 0x30};</div>
<div class="line">  echo.sendMultiOPC1(deoj, EL_INF, 0x80, edt);</div>
<div class="line"> </div>
<div class="line">  M5.Lcd.fillScreen(BLACK);</div>
<div class="line">  M5.Lcd.setTextColor(WHITE);</div>
<div class="line">  M5.Lcd.setCursor(10, 10);</div>
<div class="line">  M5.Lcd.setTextSize(3);</div>
<div class="line">  M5.Lcd.setCursor(10, 10);</div>
<div class="line">  M5.Lcd.setTextSize(3);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">int packetSize = 0;     // 受信データ量</div>
<div class="line">byte *pdcedt = nullptr; // テンポラリ</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">void loop() {</div>
<div class="line">  M5.update();</div>
<div class="line">  delay(200);</div>
<div class="line"> </div>
<div class="line">  // パケット貰ったらやる</div>
<div class="line">  packetSize = 0;</div>
<div class="line">  pdcedt = nullptr;</div>
<div class="line"> </div>
<div class="line">  if (0 != (packetSize = echo.read()) ) // 0!=はなくてもよいが，Warning出るのでつけとく</div>
<div class="line">  { // 受け取った内容読み取り，あったら中へ</div>
<div class="line"> </div>
<div class="line">    // -----------------------------------</div>
<div class="line">    // ESVがSETとかGETとかで動作をかえる</div>
<div class="line">    switch (echo._rBuffer[EL_ESV])</div>
<div class="line">    {</div>
<div class="line"> </div>
<div class="line">      // -----------------------------------</div>
<div class="line">      // 動作状態の変更 Set対応</div>
<div class="line">      case EL_SETI:</div>
<div class="line">      case EL_SETC:</div>
<div class="line">        switch (echo._rBuffer[EL_EPC])</div>
<div class="line">        {</div>
<div class="line">          case 0x80: // 電源</div>
<div class="line">            if (echo._rBuffer[EL_EDT] == 0x30)</div>
<div class="line">            { // ON</div>
<div class="line">              M5.Lcd.fillCircle(160, 120, 80, WHITE);</div>
<div class="line">              pdcedt = (byte[]){0x01, 0x30};       // ECHONET Liteの状態を変更（ライブラリに教えておく）</div>
<div class="line">              echo.update(echo._rBuffer[EL_EPC], pdcedt); // ECHONET Liteの状態を変更</div>
<div class="line">            }</div>
<div class="line">            else if (echo._rBuffer[EL_EDT] == 0x31)</div>
<div class="line">            { // OFF</div>
<div class="line">              M5.Lcd.fillCircle(160, 120, 80, BLACK);</div>
<div class="line">              pdcedt = (byte[]){0x01, 0x31};       // ECHONET Liteの状態を変更</div>
<div class="line">              echo.update(echo._rBuffer[EL_EPC], pdcedt); // ECHONET Liteの状態を変更</div>
<div class="line">            }</div>
<div class="line">            break;</div>
<div class="line"> </div>
<div class="line">          default: // 不明なEPC</div>
<div class="line">            M5.Lcd.print(&quot;??? packet esv, epc, edt is : &quot;);</div>
<div class="line">            // set</div>
<div class="line">            // ESV, EPC, EDT</div>
<div class="line">            M5.Lcd.print(echo._rBuffer[EL_ESV], HEX);</div>
<div class="line">            M5.Lcd.print(&quot; &quot;);</div>
<div class="line">            M5.Lcd.print(echo._rBuffer[EL_EPC], HEX);</div>
<div class="line">            M5.Lcd.print(&quot; &quot;);</div>
<div class="line">            M5.Lcd.println(echo._rBuffer[EL_EDT], HEX);</div>
<div class="line">            break;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        // pdcedtを使ったらクリア</div>
<div class="line">        if (pdcedt != nullptr)</div>
<div class="line">        {</div>
<div class="line">          delete[] pdcedt;</div>
<div class="line">          pdcedt = nullptr;</div>
<div class="line">        }</div>
<div class="line"> </div>
<div class="line">        if (echo._rBuffer[EL_ESV] == EL_SETC)</div>
<div class="line">        { // SETCなら返信必要</div>
<div class="line">          echo.returner();</div>
<div class="line">        }</div>
<div class="line">        break; // SETI, SETCここまで</div>
<div class="line"> </div>
<div class="line">      // -----------------------------------</div>
<div class="line">      // Get,INF_REQ対応</div>
<div class="line">      // SETの時にきちんとupdate関数でECHONET Liteの状態変更をライブラリに教えておけばここは簡素になる</div>
<div class="line">      case EL_GET:</div>
<div class="line">      case EL_INF_REQ:</div>
<div class="line">        // update関数でdetailsに状態が登録されていれば自動で返信する</div>
<div class="line">        echo.returner();</div>
<div class="line">        break; // GetとINF_REQここまで</div>
<div class="line"> </div>
<div class="line">      case EL_INF:</div>
<div class="line">        break;</div>
<div class="line"> </div>
<div class="line">      default: // 解釈不可能なESV</div>
<div class="line">        M5.Lcd.print(&quot;error? ESV = &quot;);</div>
<div class="line">        Serial.println(echo._rBuffer[EL_ESV]);</div>
<div class="line">        break;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">  // EL処理ここまで</div>
<div class="line">  // -----------------------------------</div>
<div class="line">  // パケットなかったとき、ふつうは何もしなくてよい</div>
<div class="line">  // else {</div>
<div class="line">  //}</div>
<div class="line"> </div>
<div class="line">  delay(500);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">// debug</div>
<div class="line">void printNetData()</div>
<div class="line">{</div>
<div class="line">  Serial.println(&quot;-----------------------------------&quot;);</div>
<div class="line"> </div>
<div class="line">  // IP</div>
<div class="line">  // print your WiFi shield&#39;s IP address:</div>
<div class="line">  IPAddress ip = WiFi.localIP();</div>
<div class="line">  Serial.print(&quot;IP  Address: &quot;);</div>
<div class="line">  Serial.println(ip);</div>
<div class="line"> </div>
<div class="line">  IPAddress dgwip = WiFi.gatewayIP();</div>
<div class="line">  Serial.print(&quot;DGW Address: &quot;);</div>
<div class="line">  Serial.println(dgwip);</div>
<div class="line"> </div>
<div class="line">  IPAddress smip = WiFi.subnetMask();</div>
<div class="line">  Serial.print(&quot;SM  Address: &quot;);</div>
<div class="line">  Serial.println(smip);</div>
<div class="line"> </div>
<div class="line">  Serial.println(&quot;-----------------------------------&quot;);</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md4"></a>
Description for the example</h1>
<h2><a class="anchor" id="autotoc_md5"></a>
Constractor</h2>
<p>ELクラスはWiFiのUDP（受信は3610，送信は適当）とECHONET Liteプロトコルをサポートします。ECHONET Liteネットワークにデバイスを参加させるためには専門のオブジェクトコードが必要です。オブジェクトコードはECHONET規格書に書かれているものを参照してください（https://echonet.jp/spec_g/#standard-01）。 サンプルとして一般照明（0x029001）をM5Stackで実装した例を示しています。</p>
<p><a class="el" href="class_e_l.html" title="Main class for EL">EL</a> class manages WiFiUDP (recv is 3610 port, sned is any port) and ECHONET Lite protocol. To join ECHONET Lite network, the device needs ECHONET Lite object code. ECHONET Lite object code is defined in the specifications. (see <a href="https://echonet.jp/spec-en/#standard-01">https://echonet.jp/spec-en/#standard-01</a>) In this example, we deals with M5stack as a general lighting (0x029001).</p>
<ul>
<li>single object <div class="fragment"><div class="line"> {C++}</div>
<div class="line">EL echo(elUDP, 0x02, 0x90, 0x01 );</div>
</div><!-- fragment --></li>
<li>multi object <div class="fragment"><div class="line"> {C++}</div>
<div class="line">byte devices[][3] = { {0x02, 0x90, 0x01}, {0x02, 0x90, 0x02}};</div>
<div class="line">EL echo(elUDP, devices, 2 );</div>
</div><!-- fragment --></li>
</ul>
<h3><a class="anchor" id="autotoc_md6"></a>
Initialize and Start communication（初期化と通信開始）</h3>
<p>begin()メソドを呼ぶと受信開始します。</p>
<p>To call 'begin()' method begins receiving ECHONET Lite protocol.</p>
<ul>
<li>void begin(void);</li>
</ul>
<div class="fragment"><div class="line">EL echo(elUDP, 0x02, 0x90, 0x01 );</div>
<div class="line"> </div>
<div class="line">void setup() {</div>
<div class="line">  echo.begin();</div>
<div class="line">}</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md7"></a>
Receiver（受信）</h3>
<ul>
<li>int read();</li>
</ul>
<p>受信データを読む。割り込みやコールバックではなくポーリングで実装してください。</p>
<ul>
<li>IPAddress remoteIP(void);</li>
</ul>
<p>受信データの送信元のIPアドレスを取得する。</p>
<ul>
<li>void returner(void);</li>
</ul>
<p>update関数でdetailsに状態が登録されていれば自動で返信する。</p>
<ul>
<li>byte _rBuffer[EL_BUFFER_SIZE]; // receive buffer</li>
</ul>
<p>Received data. 受信したデータ</p>
<h1><a class="anchor" id="autotoc_md8"></a>
Version</h1>
<ul>
<li>3.0.0 change method name! sendOPC1(type devId) to sendOPC1ID, also sendMultiOPC1(type devId) to sendMultiOPC1ID. workaround for overload issue. Set/GetProfile to Set/GetMyPropertyMap. additional Keyword.</li>
<li>2.9.1 calc and set automatically the identification number(0x83) (devices)</li>
<li>2.9.0 calc and set automatically the identification number(0x83) (profile)</li>
<li>2.8.2 bugfix SetProfile, GetProfile</li>
<li>2.8.0 bugfix and, Add methods of class <a class="el" href="class_p_d_c_e_d_t.html" title="PDC and EDT in ELOBJ">PDCEDT</a></li>
<li>2.7.0 Add methods of class <a class="el" href="class_e_l_o_b_j.html" title="EL Object">ELOBJ</a></li>
<li>2.6.0 Add methods of class <a class="el" href="class_p_d_c_e_d_t.html" title="PDC and EDT in ELOBJ">PDCEDT</a>, <a class="el" href="class_e_l_o_b_j.html" title="EL Object">ELOBJ</a></li>
<li>2.5.0 Add methods of class <a class="el" href="class_p_d_c_e_d_t.html" title="PDC and EDT in ELOBJ">PDCEDT</a>, <a class="el" href="class_e_l_o_b_j.html" title="EL Object">ELOBJ</a></li>
<li>2.4.0 multi set epc</li>
<li>2.3.1 bug fix</li>
<li>2.3.0 bug fix, and multi get epc</li>
<li>2.2.1 bug fix</li>
<li>2.2.0 bug fix, support multi device</li>
<li>2.1.0 considering TID</li>
<li>2.0.0 change memory management, cope with memory leak.</li>
<li>1.3.0 deal with Node profile object, error case EPC, be searched and debug mode define.</li>
<li>1.2.2 details bug fix</li>
<li>1.2.1 <a class="el" href="class_e_l.html" title="Main class for EL">EL</a> Object code defines</li>
<li>1.2.0 Readme, keywords, library.json, library.properties</li>
<li>1.1.0 organized for m5stack</li>
<li>1.0.0 M5Stack</li>
<li>0.10.0 commit and publish</li>
</ul>
<h1><a class="anchor" id="autotoc_md9"></a>
License</h1>
<p>MIT</p>
<h2><a class="anchor" id="autotoc_md10"></a>
Author</h2>
<p>神奈川工科大学 創造工学部 ホームエレクトロニクス開発学科</p>
<p>Dept. of Home Electronics, Faculty of Creative Engineering, Kanagawa Institute of Technology.</p>
<p>杉村　博</p>
<p>SUGIMURA Hiroshi </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
構築:&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6
</small></address>
</body>
</html>
